@model CallogApp.Models.Request
@section Styles{

    <link rel="stylesheet" type="text/css" href="~/css/daterangepicker.css" />
    <link rel="stylesheet" href="~/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="~/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="~/css/toastr.min.css" />
    <link rel="stylesheet" href="~/css/sweetalert.min.css" />
    <link rel="stylesheet" href="~/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="~/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="~/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" href="~/css/site2.css" />
    <style>
        .limited {
            white-space: nowrap;
            witableh: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td.details-control {
            background: url('/images/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.details td.details-control {
            background: url('/images/details_close.png') no-repeat center center;
        }

        div.polaroid {
            padding: 5px 5px 5px 5px;
            border: 1px solid #BFBFBF;
            background-color: white;
            box-shadow: 10px 10px 10px 10px #aaaaaa;
        }
    </style>

}
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}


<div class="row">
    <div class="col-md-4"></div>
    <div class="col-md-4">
        <h4>Report by category and date range</h4>
    </div>
    <div class="col-md-4"></div>
</div>
<div class="row">

    <div class="col-md-12">

        <div class="form-horizontal">




            <div class="form-group" style="width:70%;">
                <label class="control-label col-sm-2"> Date Range:</label>

                <div id="daterange" class="col-sm-8" style="background: #fff; cursor: pointer;
            padding: 5px 10px; border: 1px solid #ccc;">
                    <i class="fa fa-calendar"></i>&nbsp;
                    <span></span> <i class="fa fa-caret-down"></i>
                </div>



            </div>

            <div class="form-group" style="width:70%;">
                <label class="control-label col-sm-2">Category:</label>
                <div class="col-sm-8" style="padding-left: 0px; padding-right: 0px;">


                    <select asp-for="IssueId" id="issue"
                            class="form-control select2" asp-items="ViewBag.IssueId"></select>

                </div>


                <div class="col-sm-2">
                    <button type="button" onclick="submitSearch()" class="btn btn-primary">Find</button>
                </div>
            </div>
        </div>

    </div>



</div>



<div class="row">
    <div class="unit w-2-3 polaroid">
        <div class="hero-callout">
            <div id="example_wrapper" class="dataTables_wrapper">
                <table id="request" class="table table-bordered table-striped" style="font-size:13px">
                    <thead>
                        <tr>
                            <th>Details</th>
                            <th>Dept.</th>
                            <th>Status</th>
                            @*<th>Recvd At </th>*@
                            @*<th>Respd At </th>*@
                            <th>Resonse. Time </th>
                            <th>Resolved At </th>
                            <th>Resolution. Time </th>
                            <th>Category </th>
                            <th>Subject </th>
                            <th>Asigned To</th>
                            <th>Resolved By</th>
                            <th>Action</th>
                            <th></th>


                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot>

                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>



@section Scripts{

    <script src="~/js/jquery-3.3.1.js"></script>
    <script src="~/js/jquery.dataTables.min.js"></script>
    <script src="~/js/dataTables.buttons.min.js"></script>
    <script src="~/js/jszip.min.js"></script>
    <script src="~/js/pdfmake.min.js"></script>
    <script src="~/js//vfs_fonts.js"></script>
    <script src="~/js/buttons.print.min.js"></script>
    <script src="~/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="~/js/toastr.min.js"></script>
    <script src="~/js/sweetalert.min.js"></script>

    <script type="text/javascript">

        function format(d) {
 
    var stringConc = "<h5><strong>Created By:</strong>" + "      " + d.userId + '</h5>'
        + "<h5><strong> Created At:</strong >" + " " + d.dateCreated + '</h5>'
        + "<h5><strong> Resolved At:</strong>" + " " + d.dateResolved + '</h5>'
        + "<h5><strong> Subject:</strong>" + " " + d.subject + '</h5>'
        + "<h5><strong> Description:</strong>" + " " + d.message + '</h5>'
        + "<h5><strong>Device/Other:</strong>" + " " + d.device + ": " + d.otherDevice + '</h5>'
        + "<h5><strong>Resolution:</strong>" + " " + d.resolution + '</h5>';
        
    if (d.photoUrl !== null) {
        return stringConc + "<h5><strong>Photo:</strong>" + '<a target=" _blank" href="'+ d.photoUrl +'"> View attachement</a>';   
    }
    else {
        return stringConc;
    }
    

        }
        $(document).ready(function () {

            var table = $("#request").DataTable({

                select: true,
                dom: 'Bfrtip',
                "columns": [
                    {
                        "class": "details-control",
                        "orderable": false,
                        "data": null,
                        "defaultContent": '<i class = "glyphicon glyphicon-plus-sign bg-success text-white"> </i>',
                    },
                    { "data": "department" },
                    {
                        "render": function (data, type, full) {

                            var status = `${full.status}`;

                            if (status === 'Resolved') {
                                return `<div style="color:green" class="fa fa-check"><strong>${status}</strong></div>`;
                            }

                            return `<div style="color:red" class="fa fa-circle">${status}</div>`;
                        }
                    },
           
                    {
                        "render": function (data, type, full) {

                            var resolvTime = `${full.responseDate}`;
                            // alert(resolvTime)
                            if (resolvTime === '00:00:00') {

                                return `<div style="color:red"></div>`

                            }
                            else {
                                return `<div style="color:red">${full.responseDate}</div>`
                            }
                        }
                    },
                    { "data": "dateResolved" },
                    {
                        "render": function (data, type, full) {

                            var respTime = `${full.resolvedDate}`;
                            if (respTime === '00:00:00') {

                                return `<div style="color:red"></div>`

                            }
                            else {
                                return `<div style="color:red">${full.resolvedDate}</div>`
                            }
                        }
                    },
                    //{ "data": "issue" },
                    {
                        "render": function (data, type, full) {

                            var isIssue = `${full.issue}`;
                            if (isIssue === 'OTHER') {

                                return `<div>${full.otherIssue}</div>`

                            }
                            else {
                                return `<div>${full.issue}</div>`
                            }
                        }
                    },
                    { "data": "subject" },
                    { "data": "itStaff" },
                    { "data": "resolvedBy" },
                    //{ "data": "userId" },
                    {
                        "render": function (data, type, full) {

                            var isCancel = `${full.isCancel}`;
                            if (isCancel === 'True') {
                                return `<div style="color:red">Canceled</div>`

                            }

                            var status = `${full.status}`;

                            if (status === 'Resolved') {
                                return `<span><strong>Closed</strong></span>
 <a href="/User/UserComment/GetAllCommentsByRequest/${full.id}"  class='style='cursor:pointer;'><i class='fa fa-eye text-primary'>View comment</i></a>
`;
                            }
                            else {
                                return `<div class="text-center" id="editDiv">
                         <a href="/User/UserRequest/Edit/${full.id}" class='style='cursor:pointer;'><i class='fa fa-edit text-success'>edit</i></a>
                        &nbsp<a class='btn text-danger style='cursor:pointer;font-size:14px' onclick=Cancel('/api/userrequest?id='+${full.id})><i class='fa fa-window-close text-danger'>cancel</i></a>
                           </div>`;
                            }


                        }
                    },
                    {
                        "data": "isCancel", "render": function (data) {

                            return `<div hidden>${data}</div>`
                        }
                    }

                ],
            });

            var detailRows = [];

            $('#request tbody').on('click', 'tr td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);
                var idx = $.inArray(tr.attr('id'), detailRows);

                if (row.child.isShown()) {
                    tr.removeClass('details');
                    row.child.hide();

                    // Remove from the 'open' array
                    detailRows.splice(idx, 1);
                }
                else {
                    tr.addClass('details');
                    row.child(format(row.data())).show();

                    // Add to the 'open' array
                    if (idx === -1) {
                        detailRows.push(tr.attr('id'));
                    }
                }
            });

            // On each draw, loop over the `detailRows` array and show any child rows
            table.on('draw', function () {
                $.each(detailRows, function (i, id) {
                    $('#' + id + ' td.details-control').trigger('click');
                });
            });
        });

        function RefreshTable(tableId, theData) {
            table = $(tableId).dataTable();
            oSettings = table.fnSettings();
            table.fnClearTable(this);
            for (var x = 0; x < theData.length; x++) {
                table.oApi._fnAddData(oSettings, theData[x]);
            }
            oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
            table.fnDraw();


        }


        function submitSearch() {


            if ($('#issue').val() == "") {
                swal("Select a issue");
                return;
            }

            var category = $("#issue").val();
            var start = $('#daterange').data('daterangepicker').startDate;
            var end = $('#daterange').data('daterangepicker').endDate;

            var thePost = "?startDate=" + start.format('YYYY-MM-DD') + "&endDate=" + end.format('YYYY-MM-DD') + "&category=" + category;

            $.ajax({
                "processing": true,
                "serverSide": true,
                "url": "/api/requestreports/category" + thePost,
                "type": "GET",
                "datatype": "json",

                success: function (data) {
                    console.log(data);
                    RefreshTable("#request", data);
                }, error: function (xhr, ajaxOptions, thrownError) {
                    swal(ajaxOptions, xhr.responseText);
                }

            });


        }




        $(function () {

            var start = moment().subtract(29, 'days');
            var end = moment();

            function cb(start, end) {
                $('#daterange span').html(start.format('YYYY-MM-DD') + ' / ' + end.format('YYYY-MM-DD'));
            }

            $('#daterange').daterangepicker({
                startDate: start,
                endDate: end,
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);

            cb(start, end);

        });




    </script>


    <script type="text/javascript" src="~/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="~/js/moment.min.js"></script>
    <script type="text/javascript" src="~/js/daterangepicker.min.js"></script>
    <script src="~/js/dataTables.responsive.min.js"></script>

    <script>


        $(document).ready(function () {
            $('#example')
                .addClass('nowrap')
                .dataTable({
                    responsive: true,
                    columnDefs: [
                        { targets: [-1, -3], className: 'dt-body-right' }
                    ]
                });
        });


    </script>
}
